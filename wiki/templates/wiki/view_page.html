{% extends 'wiki/base.html' %}

{% block title %}{{ page.title }} - MeBox{% endblock %}

{% block og_type %}article{% endblock %}

{% block og_url %}{% if request %}{{ request.scheme }}://{{ request.get_host }}{% url 'view_wiki_page' page.author.username page.slug %}{% endif %}{% endblock %}

{% block og_title %}{{ page.title }} - {{ page.author.username }}'s Wiki Page{% endblock %}

{% block og_description %}
{% if page.content|length < 200 %}
{{ page.content|striptags|truncatechars:200 }}
{% else %}
{{ page.content|striptags|truncatechars:200 }}...{% endif %}
{% endblock %}

{% block content %}
    <div style="margin-bottom: 20px;">
        <h1>{{ page.title }}</h1>
        <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
            <span><strong>By:</strong> <a href="{% url 'user_profile' page.author.username %}">{{ page.author.username }}</a></span>
            <span><strong>Created:</strong> {{ page.created_at|date:"F j, Y" }}</span>
            {% if page.updated_at != page.created_at %}
                <span><strong>Updated:</strong> {{ page.updated_at|date:"F j, Y" }}</span>
            {% endif %}
        </div>
        
        {% if user == page.author %}
            <div style="margin-top: 15px;">
                <a href="{% url 'edit_wiki_page' page.id %}" class="btn">Edit</a>
                <a href="{% url 'view_revisions' page.id %}" class="btn">View History</a>
                <a href="{% url 'delete_wiki_page' page.id %}" class="btn btn-secondary">Delete</a>
            </div>
        {% endif %}
    </div>
    
    <div class="markdown-content">
        {{ html_content|safe }}
    </div>
    
    <script>
        // Fix wiki link URLs to use the correct format
        document.addEventListener('DOMContentLoaded', function() {
            const wikiLinks = document.querySelectorAll('a[data-wiki-link]');
            const currentUsername = '{{ username }}';
            
            wikiLinks.forEach(link => {
                const targetSlug = link.getAttribute('data-wiki-link');
                const targetUsername = link.getAttribute('data-wiki-username');
                const href = link.getAttribute('href');
                const isInvalid = link.classList.contains('wiki-link-invalid');
                
                // Replace .html with the correct user/page format
                if (href && href.endsWith('.html')) {
                    // Cross-user link: User:username/page
                    if (targetUsername) {
                        const newHref = `/user/${targetUsername}/${targetSlug}/`;
                        link.setAttribute('href', newHref);
                        
                        // If invalid cross-user link, add click handler for 404
                        if (isInvalid) {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                alert('This page does not exist in the target user\'s namespace.');
                            });
                        }
                    } else {
                        // Same-user link: [[page]]
                        const newHref = `/user/${currentUsername}/${targetSlug}/`;
                        link.setAttribute('href', newHref);
                        
                        // If invalid same-user link, redirect to create page
                        if (isInvalid) {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                window.location.href = `/user/${currentUsername}/${targetSlug}/create/`;
                            });
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}